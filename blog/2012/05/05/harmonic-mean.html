<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ru" lang="ru-ru">
<head>
	 <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
	 <meta http-equiv="content-type" content="text/html; charset=utf-8" />
	 <title>Гармоническое среднее</title>
	 <meta name="author" content="Denis Bazhenov" />
	 <link href="http://feeds.feedburner.com/severe-reality" rel="alternate" title="Severe Reality" type="application/atom+xml" />
	 <link href='http://fonts.googleapis.com/css?family=Open+Sans:300,400,600&subset=latin,cyrillic-ext,cyrillic' rel='stylesheet' type='text/css'>
	 
	 <link rel="openid2.provider" href="https://www.google.com/accounts/o8/ud?source=profiles" > 
	 <link rel="openid2.local_id" href="http://www.google.com/profiles/dotsid" >
	 
	 <!-- syntax highlighting CSS -->
	 <link rel="stylesheet" href="/css/syntax.css" type="text/css" />
	 <!-- Homepage CSS -->
	 <link rel="stylesheet" href="/css/screen.css" type="text/css" media="screen, projection" />
	 <link rel="stylesheet" href="http://yandex.st/highlightjs/6.1/styles/idea.min.css">

	<script src="http://code.jquery.com/jquery-1.7.1.min.js"></script>
</head>
<body>

	<div class="site">
		
			<header>
				<div class="content">
					<a href="/">Суровая реальность</a>
				</div>
			</header>
		

		<div class="post content">
	<h1>Гармоническое среднее</h1>
	<div class="meta">
		<span class="date">05 May 2012</span>
		<span class="tags">
			
				<a href="/tags.html#unix">unix</a>
			
				<a href="/tags.html#operation">operation</a>
			
				<a href="/tags.html#monitoring">monitoring</a>
			
		</span>
		
	</div>
	
	
	<p>Сегодня я хочу обсудить следующую проблему. Как мониторить CPU usage на многопроцессорной машине? Конечно же мониторить метрики выдываемые <code>mpstat</code>. Эта программа выдает процент времени который процессор проводит в различных состояниях (<code>user</code>, <code>system</code>, <code>iowait</code>, <code>idle</code> и т.д.).</p>

<!--excerpt-->

<pre class="shell"><code>$ mpstat 1
Linux 2.6.32-200.13.1.el5uek (search-personal2.vfarm.loc)		05/05/2012 	_x86_64_	(16 CPU)

11:35:52 AM  CPU    %usr   %nice    %sys %iowait    %irq   %soft  %steal  %guest   %idle
11:35:53 AM  all    8.34    0.00    0.59    0.06    0.00    0.12    0.00    0.00   90.89
11:35:54 AM  all    7.27    0.00    0.86    0.00    0.00    0.36    0.00    0.00   91.51
11:35:55 AM  all    7.80    0.00    0.45    0.06    0.00    0.17    0.00    0.00   91.53
11:35:56 AM  all    5.33    2.17    0.84    0.00    0.00    0.14    0.00    0.00   91.52
11:35:57 AM  all    5.92    0.00    0.40    0.06    0.00    0.06    0.00    0.00   93.57
11:35:58 AM  all    4.71    0.07    0.42    0.00    0.00    0.14    0.00    0.00   94.67
</code></pre>

<p>В ретроспективе это выглядит следующим образом:</p>

<p class="image photo"><img src="/images/harmonic-mean/fig1.png" alt="CPU usage" /></p>

<p>Может показаться что у этого сервера нет никаких проблем с CPU. Тем не менее надо учитывать что машина многопроцессорная и может оказаться что нагрузка на ядра не симмитрична. <code>mpstat</code> же показывает арифметическое среднее, поэтому если вы на 16 процессорной машине видите CPU utilization 6% это может означать:</p>

<ul>
  <li>машина загружена симметрично и у каждого ядра есть еще масса свободного времени;</li>
  <li>машина загружена не симметрично – одно ядро работает на 100%, а все остальные курят бамбук.</li>
</ul>

<p>Конечно же последний случай это явная проблема и система мониторинга должна позволять находить такие ситуации. Но что мониторить чтобы находить ассиметричную нагрузку на различные ядра?</p>

<h2 id="section">Мониторинг</h2>

<h3 id="load-average">Load average</h3>
<p><a href="http://en.wikipedia.org/wiki/Load_(computing)">Load average</a> (<code>uptime</code>, <code>w</code>) не позволяет отследить подобную ассиметричность в нагрузке, так как ее следствием является работа, которая не может быть выполнена параллельно. В этом случае в системе не будет длинной очереди CPU scheduler&rsquo;а, а это именно то что и показывает load average.</p>

<h3 id="section-1">Мониторить отдельно каждое ядро</h3>
<p>Можно отслеживать ассиметричность имея информацию по CPU usage для каждого отдельного ядра (на подобии той которая приведена в начале заметки). Но это, как вы можете догадаться довольно напряжно. Слишком много данных, которые надо пропустить через мозг чтобы получить информацию.</p>

<h3 id="cpu-utilization">Экстремальные значения CPU utilization</h3>
<p>Можно мониторить например максимальное значение CPU utilization. Это позволит понять какая утилизация у самого загруженного ядра в системе. Благодаря этому можно отследить ситуацию ассиметричной нагрузки по разнице между арифметическим средним и максимальным значением утилизации.</p>

<p>Мы мониторим <a href="http://en.wikipedia.org/wiki/Harmonic_mean">гармоническое среднее</a>. <em>Гармоническое среднее, в отличии арифметического стремится к нулю когда хотя бы одно из значений стремится к нулю.</em> Считается оно тоже довольно просто — количество значений деленное на сумму обратных значений:</p>

<script type="math/tex; mode=display">\frac{n}{\sum\limits_{i=1}^n \frac{1}{x_i}}</script>

<p>То есть для двух процессоров idle которых равен 3 и 100, гармоническое среднее равно: <script type="math/tex">\frac{2}{\frac{1}{3} + \frac{1}{100}} \approx 5.8</script></p>

<p>Если добавить на график который я привел выше, гармоническое среднее утилизации, то мы получим следующее:</p>

<p class="image photo"><img src="/images/harmonic-mean/fig2.png" alt="CPU Harmonic Utilization" /></p>

<p>Здесь видно что большую часть времени нагрузка распределяется равномерно (светло синей области практически не видно). Тем не менее в период с 1:10 до 1:20 нагрузка на CPU ассиметрична, что говорит о выполнении задачи которая не может быть распараллелена.</p>

<h2 id="section-2">Что может быть причиной?</h2>

<p>Это может быть любая активность которая не может быть эффективно распараллелена. Например, банальный <code>grep</code> по большому объему данных (если он не упрется в I/O), сжатие, потоковое кодирование видео, шифрование, некоторые алгоритмы GC в JVM однопоточные по своей природе.</p>

<p>Более подробно об этом явлении я уже писал ранее в заметке &ldquo;<a href="/blog/2009/01/13/moores-law-a-la-finita.html">Конец эры закона Мура</a>&rdquo;.</p>

<p class="update">В коментариях мне подсказали что стоит также посмотреть в <code>/proc/interrupts</code> и в графы <code>%irq</code> и <code>%soft</code> вывода <code>mpstat</code>. На системах с высокой сетевой или дисковой нагрузкой может быть довольно большое число прерываний на одном ядре.</p>

<h2 id="section-3">Что делать в этой ситуации?</h2>
<p>Во-первых, надо понять является ли это проблемой. Вполне возможно, что эта ситуация может быть вызвана какой-нибудь background задачей, которая ни коим образом не затрагивает пользователей. Если же данная ситуация влияет на качество сервиса предоставляемого пользователям, то определенно надо более точно локализовать проблему и попытаться разрешить ее.</p>

<p>На ОС Linux в диагностике подобного рода проблем вам могут помочь следующие инструменты:</p>

<ul>
  <li>команда <code>pidstat -u -t -p $PID 1</code> позволяет выяснить какие потоки указанного процесса кушают CPU наиболее активно. Эта команда может быть использована в том числе и для диагностики проблем JVM приложений, так как потоки JVM напрямую соотносятся с потоками ОС;</li>
  <li>для получения информации по потокам JVM может быть полезна команда <code>jstack $PID</code>, которая делает thread dump JVM приложения (<code>jstack</code> является частью JDK и не входит в комплект поставки JRE);</li>
  <li>для получения трейса конкретного потока можно воспользоваться командами <code>strace</code>/<code>ltrace</code>. Они показывают трейс системных вызовов и библиотечных вызовов соответственно.</li>
</ul>

<p>Надеюсь эти инструменты помогут вам диагностировать подобные ситуации быстро и безболезненно.</p>



	<div class="bar">
		<div class="g-plusone" data-size="medium"></div>
		<a href="https://twitter.com/share" class="twitter-share-button"
			data-url="http://bazhenov.me/blog/2012/05/05/harmonic-mean.html"
			data-via="denis_bazhenov" data-lang="en">Tweet</a>

		<a href="https://twitter.com/denis_bazhenov" class="twitter-follow-button"
			data-show-count="false">Follow</a>
	</div>

	<div id="disqus_thread"></div>
	<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>

<!-- Google +1 button -->
<script type="text/javascript">
	(function() {
		var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
		po.src = 'https://apis.google.com/js/plusone.js';
		var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
	})();
</script>

<!-- Twitter buttons -->
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>

<!-- Disqus -->
<script type="text/javascript">
	/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
	var disqus_shortname='severe-reality';
	var disqus_developer=false;

	/* * * DON'T EDIT BELOW THIS LINE * * */
	(function() {
		var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
		dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
		(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	})();
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type="text/javascript">
	MathJax.Hub.Config({
		tex2jax: {
			inlineMath: [['$','$'], ['\\(','\\)']],
			processEscapes: true
		}
	});
</script>

		<footer>
			<div class="content">
				<a href="http://feeds.feedburner.com/severe-reality">RSS Subscribe</a>
					|
				<a href="mailto:dotsid@gmail.com">Email</a>
			</div>
		</footer>
					
	</div>
	
	<script src="http://yandex.st/highlightjs/6.1/highlight.min.js"></script>
	<script>
	$(document).ready(function() {
		$('pre.code code').each(function(i, e) {hljs.highlightBlock(e, '  ')});
	});
	</script>
	
	
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-31484732-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>

</body>
</html>