<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ru" lang="ru-ru">
<head>
	 <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
	 <meta http-equiv="content-type" content="text/html; charset=utf-8" />
	 <title>Оптимистическая блокировка</title>
	 <meta name="author" content="Denis Bazhenov" />
	 <link href="http://feeds.feedburner.com/severe-reality" rel="alternate" title="Severe Reality" type="application/atom+xml" />

	 <link href='http://fonts.googleapis.com/css?family=Open+Sans:300,400,600&subset=latin,cyrillic-ext,cyrillic' rel='stylesheet' type='text/css'>
	 <!-- syntax highlighting CSS -->
	 <link rel="stylesheet" href="/css/syntax.css" type="text/css" />

	 <!-- Homepage CSS -->
	 <link rel="stylesheet" href="/css/screen.css" type="text/css" media="screen, projection" />
	 <link rel="stylesheet" href="http://yandex.st/highlightjs/6.1/styles/idea.min.css">

	<script src="http://code.jquery.com/jquery-1.7.1.min.js"></script>
</head>
<body>

	<div class="site">

		<header>
			<div class="content">
				<a href="/">Суровая реальность</a>
			</div>
		</header>

		<div class="post content">
	<h1>Оптимистическая блокировка</h1>
	<div class="meta">
		<span class="date">23 October 2009</span>
		<span class="tags">
			
				<a href="/tags.html#concurrency">concurrency</a>
			
				<a href="/tags.html#mysql">mysql</a>
			
				<a href="/tags.html#php">php</a>
			
		</span>
		
	</div>
	
	
	<p>Shared state, как известно необходимо защищать. Иначе параллельные потоки могут его &ldquo;поломать&rdquo;. Это относится и к web-приложениям. Несмотря на отсутствие вменяемой поддержки параллелизма в большинстве web-ориентированных языков (PHP, Python, Ruby), concurrency в web-приложениях хватает. Запросы приходят на web-сервер параллельно, исполняются на разных процессорах параллельно и т.д. По этой причине следующий код некорректен:</p>

<pre class="code"><code>$bulletin = $manager-&gt;findBulletinById($request-&gt;id);
$bulletin-&gt;setHits( $bulletin-&gt;getHits()+1 );
$manager-&gt;saveBulletin($bulletin);
</code></pre>

<p>Два параллельных потока могут одновременно загрузить объявление, одновременно инкрементировать счетчик, и записать объявление обратно. Это приведет к тому, что один инкремент потеряется. В общем случае, если <code>N</code> потоков выполняют данный код одновременно, может быть потеряно до <code>N - 1</code> update&rsquo;ов.</p>

<p>Существует два принципиально разных способа обеспечения целостности данных: пессимистическая и <a href="http://en.wikipedia.org/wiki/Optimistic_concurrency_control">оптимистическая блокировка</a>. Пессимистическая блокировка исходит из предположения, что если мы выполняем код, конкурентное выполнения которого может привести к &ldquo;поломке&rdquo; данных, то необходимо исключить его конкурентное исполнение. То есть сериализовать потоки в этой точке. Достигается это или при помощи distributed lock&rsquo;ов или транзакций в БД.</p>

<p>У нас в системе есть небольшая библиотека позволяющая реализовать в коде исключающую блокировку. Ее использование выглядит примерно следующим образом:</p>

<pre class="code"><code>$lock = LockManager::getLock("bulletin:{$request-&gt;id}");
try {
  $bulletin = $manager-&gt;findBulletinById($request-&gt;id);
  $bulletin-&gt;setHits( $bulletin-&gt;getHits()+1 );
  $manager-&gt;saveBulletin($bulletin);
  $lock-&gt;release();
} catch ( Exception $e ) {
  $lock-&gt;release();
}
</code></pre>

<p>Пессимистическая блокировка схожа с принципом Мерфи. Она предполагает, что если что-то плохое может случится, это обязательно случится. В отличии от пессимистической, оптимистическая блокировка предполагает что во время обновления записи в БД мы будем единственными кто ее меняет. В большинстве случаев, так и есть, так что оптимизм оправдан. Тем не менее, во время UPDATE&rsquo;а мы проверяем наверняка изменилась ли запись с момента ее чтения. И если изменилась, то мы обязаны прочитать последнюю версию записи из БД и повторить нашу операцию с ней.</p>

<h2 id="section">Реализация</h2>
<p>Реализуется это довольно просто. Достаточно хранить с каждой записью в БД идентификатор версии и при записи проверять что он не изменился и менять его. Алгоритм выглядит следующим образом.</p>

<pre class="code"><code>public function saveBulletin(Bulletin $bulletin) {
  $connection-&gt;prepareStatement("UPDATE bulletins SET version = version + 1 ... ".
    "WHERE id = :id AND version = :version")
  -&gt;int('id', $bulletin-&gt;getId())
  -&gt;int('version', $bulletin-&gt;getVersion())
  -&gt;execute();
  if ( $connection-&gt;rowsAffected() &lt;= 0 ) {
    throw new ConcurrentModificationException();
  }
}
</code></pre>

<p>В данном методе при обновлении мы проверяем, что версия не изменилась, а это значит, что и запись в БД никто не менял. Если версия изменилась, мы обязаны известить об этом клиента.</p>

<p>Но тут есть одна загвоздка. Что будет делать клиент с этим exception&rsquo;ом?</p>

<pre class="code"><code>try {
  $manager-&gt;saveBulletin($bulletin);
} catch ( ConcurrentModificationException $e ) {
  // Huh?!
}
</code></pre>

<p>По идее, клиент должен заново прочитать объявление из БД, заново выполнить свою операцию и заново сохранить объявление. И вполне возможно что&hellip; заново получить exception, заново прочитать объявление и&hellip; Нет, так не пойдет.</p>

<p>В случае, если вы реализуете оптимистическую блокировку, то модель должна взять на себя логику сохранения объектов, иначе вы <code>опухнете писать клиентов</code>. Модель должна предоставить иной, более удобный интерфейс для оперирования над объектами. Используя возможности PHP/5.3 можно сделать следующее:</p>

<pre class="code"><code>$manager-&gt;processBulletin($request-&gt;id, function(Bulletin $b) {
  $b-&gt;setHits( $b-&gt;getHits()+1 );
});
</code></pre>

<p>Как видно, в данном случае клиент не загружает и не сохраняет объявление. А это значит, что и с конкурентными изменениями ему иметь дело не требуется, — все это ответственность модели. Реализовать в модели цикл сохранения объекта с обработкой ошибок — дело техники.</p>

<h2 id="section-1">Преимущества &ldquo;оптимистов над пессимистами&rdquo;</h2>

<h3 id="section-2">Не блокирует клиентов, которые не меняют состояние</h3>

<p>Представьте себе такой код:</p>

<pre class="code"><code>$bulletin = $manager-&gt;findBulletinById(...);
if ( $bulletin-&gt;getText() != $request-&gt;text ) {
  $bulletin-&gt;setText($request-&gt;text);
  $manager-&gt;saveBulletin($bulletin);
}
</code></pre>

<p>В случае пессимистической блокировки мы обязаны взять lock перед загрузкой объявления. Но возможно, что нам даже менять его не потребуется. Тем не менее, мы потенциально можем быть заблокированы на lock&rsquo;е, даже если ничего не будем менять. В случае оптимистической блокировки мы просто не сохраняем объявление.</p>

<h3 id="lock">Избавляет клиента от необходимости заботится о lock&rsquo;ах</h3>

<p>В случае оптимистической блокировки клиентский код <em>проще</em> и этого <em>кода</em> требуется меньше. Меньше кода → меньше проблем.</p>

<h3 id="section-3">Гарантировано защищает данные</h3>

<p>Когды вы оперируете lock&rsquo;ами могут случиться четыре типа проблем:</p>

<ul>
  <li>вы возьмете слишком мало локов (поломанные данные);</li>
  <li>вы возьмете слишком много локов (<a href="http://en.wikipedia.org/wiki/Deadlock">deadlock</a>, <a href="http://en.wikipedia.org/wiki/Resource_starvation">starvation</a>);</li>
  <li>вы возьмете не те локи (поломанные данные);</li>
  <li>вы возьмете те локи, но не в том порядке (deadlock).</li>
</ul>

<p>Если вы хотите чтобы пессимистическая блокировка корректно работала в больших системах, требуется чтобы программисты, которые пишут клиентский код, четко осознавали суть конкурентных процессов, были очень внимательны и чтобы у них было 5 килограммов мозга. Скорее всего у них, как и у большинства других нормальных людей, мозг весит только 3 килограмма. Так что не стоит спихивать на них задачу модели, а именно — обеспечение целостности данных.</p>

<p>Худшее что может случится в случае оптимистической блокировки — клиент получит exception. Худшее что может случится в случае пессимистической блокировки — вы <em>&ldquo;поломаете&rdquo; данные</em>.</p>

<p>Что вы выбираете?</p>



	<div class="bar">
		<div class="g-plusone" data-size="medium"></div>
		<a href="https://twitter.com/share" class="twitter-share-button"
			data-url="http://bazhenov.me/blog/2009/10/23/optimistic-locking.html"
			data-via="denis_bazhenov" data-lang="en">Tweet</a>

		<a href="https://twitter.com/denis_bazhenov" class="twitter-follow-button"
			data-show-count="false">Follow</a>
	</div>

	<div class="related">
		<h2>Related Posts</h2>
		<ul class="posts">
			
				<li>
					<span>16 Apr 2012</span> &raquo;
					<a href="/blog/2012/04/16/one-in-a-million.html">Один на миллион</a>
				</li>
			
				<li>
					<span>26 Feb 2012</span> &raquo;
					<a href="/blog/2012/02/26/highload.html">О высокой нагрузке</a>
				</li>
			
				<li>
					<span>10 Jun 2011</span> &raquo;
					<a href="/blog/2011/06/10/deploy.html">Deploy и прочие неприятности</a>
				</li>
			
		</ul>
	</div>

	<div id="disqus_thread"></div>
	<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>

<!-- Google +1 button -->
<script type="text/javascript">
	(function() {
		var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
		po.src = 'https://apis.google.com/js/plusone.js';
		var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
	})();
</script>

<!-- Twitter buttons -->
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>

<!-- Disqus -->
<script type="text/javascript">
	/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
	var disqus_shortname='severe-reality';
	var disqus_developer=true;

	/* * * DON'T EDIT BELOW THIS LINE * * */
	(function() {
		var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
		dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
		(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	})();
</script>

		<footer>
			<div class="content">
				<a href="http://feeds.feedburner.com/severe-reality">RSS Subscribe</a>
					|
				<a href="mailto:dotsid@gmail.com">Email</a>
			</div>
		</footer>
					
	</div>

	<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
	
	<script src="http://yandex.st/highlightjs/6.1/highlight.min.js"></script>
	<script>
	$(document).ready(function() {
		$('pre.code code').each(function(i, e) {hljs.highlightBlock(e, '  ')});
	});
	</script>
	<script type="text/javascript">
		MathJax.Hub.Config({
			tex2jax: {
				inlineMath: [['$','$'], ['\\(','\\)']],
				processEscapes: true
			}
		});
	</script>

</body>
</html>